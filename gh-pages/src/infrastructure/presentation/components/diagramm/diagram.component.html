<div class="container">
  <p
    *ngIf="statusMessage"
    class="status"
    [ngClass]="{
      success: statusType === 'success',
      error: statusType === 'error',
      info: statusType === 'info',
    }">
    {{ statusMessage }}
  </p>
  <section class="controls">
    <div class="control-group project-controls">
      <div class="form-field project-name-field">
        <label for="projectNameInput">Project Name</label>
        <input
          id="projectNameInput"
          type="text"
          placeholder="Enter Project name"
          class="text-input"
          [(ngModel)]="projectName"
          (input)="onProjectNameChange()" />
      </div>
      <div class="form-field">
        <button
          type="button"
          class="btn btn-secondary reset"
          (click)="getEmptyConfig()">
          Reset Diagramm
        </button>
      </div>
    </div>
  </section>

  <section class="controls">
    <div class="control-group">
      <span class="generate-node-label">Add Nodes to Diagram</span>

      <!-- Entity Row -->
      <div class="node-add-row">
        <label for="entityNameInput" class="node-type-label">Entity</label>
        <input
          id="entityNameInput"
          type="text"
          [(ngModel)]="entityName"
          placeholder="Enter entity name"
          class="text-input node-name-input" />
        <button
          type="button"
          class="btn btn-primary add-node-btn"
          (click)="handleAddNode('entity')"
          [disabled]="!entityName.trim()">
          <span class="btn-text-full">Add Entity</span>
          <span class="btn-text-short">Add</span>
        </button>
      </div>

      <!-- Domain Service Row -->
      <div class="node-add-row">
        <label for="domainServiceNameInput" class="node-type-label"
          >Domain Service</label
        >
        <input
          id="domainServiceNameInput"
          type="text"
          [(ngModel)]="domainServiceName"
          placeholder="Enter domain service name"
          class="text-input node-name-input" />
        <button
          type="button"
          class="btn btn-primary add-node-btn"
          (click)="handleAddNode('domain')"
          [disabled]="!domainServiceName.trim()">
          <span class="btn-text-full">Add Domain Service</span>
          <span class="btn-text-short">Add</span>
        </button>
      </div>

      <!-- Application Service Row -->
      <div class="node-add-row">
        <label for="applicationServiceNameInput" class="node-type-label"
          >Application Service</label
        >
        <input
          id="applicationServiceNameInput"
          type="text"
          [(ngModel)]="applicationServiceName"
          placeholder="Enter application service name"
          class="text-input node-name-input" />
        <button
          type="button"
          class="btn btn-primary add-node-btn"
          (click)="handleAddNode('application')"
          [disabled]="!applicationServiceName.trim()">
          <span class="btn-text-full">Add Application Service</span>
          <span class="btn-text-short">Add</span>
        </button>
      </div>
      <button
        *ngIf="selectedNode"
        class="btn btn-danger"
        (click)="handleRemoveNode()">
        Remove “{{ selectedNode }}”
      </button>
    </div>
  </section>

  <div class="wrapper">
    <header class="header">
      <div class="instruction-list">
        <p>Instructions:</p>
        <ol>
          <li>Click nodes to select them</li>
          <li>Then click another node to create a connection</li>
          <li>Connections must stay within one ring distance</li>
        </ol>
      </div>
      <div class="diagram-wrapper">
        <div #containerRef class="diagram-container"></div>
      </div>
    </header>
    <header class="header">
      <div class="instruction-list" id="no-show">
        <p>Instructions:</p>
        <ol>
          <li>Click nodes to select them</li>
          <li>Then click another node to create a connection</li>
          <li>Connections must stay within one ring distance</li>
        </ol>
      </div>
      <div class="diagramAndCodeWrapper">
        <div>
          <ng-container *ngIf="showDataSummary; else codeBlock">
            <section class="data-summary">
              <h3>Current Elements:</h3>
              <div class="summary-grid">
                <div class="summary-column">
                  <strong>Entities ({{ data!.entities!.length || 0 }}):</strong>
                  <ul>
                    <li *ngFor="let e of data?.entities || []">{{ e }}</li>
                  </ul>
                </div>
                <div class="summary-column">
                  <strong
                    >Domain Services ({{
                      data!.domainServices!.length || 0
                    }}):</strong
                  >
                  <ul>
                    <li *ngFor="let s of data?.domainServices || []">
                      {{ s }}
                    </li>
                  </ul>
                </div>
                <div class="summary-column">
                  <strong
                    >Application Services ({{
                      data!.applicationServices!.length || 0
                    }}):</strong
                  >
                  <ul>
                    <li *ngFor="let s of data?.applicationServices || []">
                      {{ s }}
                    </li>
                  </ul>
                </div>
                <div class="summary-column">
                  <strong>Repositories ({{ repositories.length }}):</strong>
                  <ul>
                    <li *ngFor="let r of repositories">{{ r }}</li>
                  </ul>
                </div>
              </div>
            </section>
          </ng-container>
          <ng-template #codeBlock>
            <app-code-display
              class="code-display"
              [filename]="filename"
              [content]="generatedCode"></app-code-display>
          </ng-template>
          <div class="json-controls">
            <button
              class="btn btn-primary"
              id="jsonDownload"
              (click)="saveData()">
              Download JSON
            </button>
            <button
              class="btn btn-secondary"
              id="jsonUpload"
              (click)="openUploadModal()">
              Upload JSON
            </button>
            <div>
              <mat-slide-toggle
                class="data-summary-toggle"
                [(ngModel)]="showDataSummary">
                Toggle Onion Summary / Code Display
              </mat-slide-toggle>
            </div>
          </div>
        </div>
      </div>
    </header>
  </div>
  <section *ngIf="hasSelectedNode" class="selected-panel">
    <h3>
      {{ selectedNode }}
      <small>{{ selectedNodeRing }}</small>
    </h3>

    <div *ngIf="currentConnections.length; else noConn">
      <strong>Connections:</strong>
      <ul>
        <li *ngFor="let tgt of currentConnections">
          <span class="connection-target">{{ tgt }}</span>
          <button
            class="btn btn-remove-connection"
            (click)="removeConnection(tgt)">
            ✕
          </button>
        </li>
      </ul>
    </div>
    <ng-template #noConn>
      <em>No connections yet.</em>
    </ng-template>
  </section>
</div>

<app-json-upload-modal
  [isOpen]="showUploadModal"
  (fileUploaded)="onFileUploaded($event)"
  (modalClosed)="onModalClosed()">
</app-json-upload-modal>
