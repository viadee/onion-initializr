import{a as k,g as c}from"./chunk-TSRGIXR5.js";var B="https://stackblitz.com";var m=class{_bus=new EventTarget;listen(t){function r(n){t(n.data)}return this._bus.addEventListener("message",r),()=>this._bus.removeEventListener("message",r)}fireEvent(t){this._bus.dispatchEvent(new MessageEvent("message",{data:t}))}};var ue=new Error;ue.stack="";var fe=new m;function q(e){return fe.listen(e)}var x={},S=null,E={get editorOrigin(){return S==null&&(S=new URL(globalThis.WEBCONTAINER_API_IFRAME_URL??B).origin),S},set editorOrigin(e){S=new URL(e).origin},setQueryParam(e,t){x[e]=t},get url(){let e=new URL(this.editorOrigin);e.pathname="/headless";for(let t in x)e.searchParams.set(t,x[t]);return e.searchParams.set("version","1.6.1"),e}};function J(){let e,t;function r(){t=new Promise(n=>e=n)}return r(),{get promise(){return t},resolve(n){return e(n)},reset:r}}var p={initialized:!1,bootCalled:!1,authComplete:J(),clientId:"",oauthScope:"",broadcastChannel:null,get editorOrigin(){return E.editorOrigin},tokens:null},it=new m,at=new m;function Y(e){if(!e)throw new Error("Oops! Tokens is not defined when it always should be.")}var _=(function(e){return e.UncaughtException="PREVIEW_UNCAUGHT_EXCEPTION",e.UnhandledRejection="PREVIEW_UNHANDLED_REJECTION",e.ConsoleError="PREVIEW_CONSOLE_ERROR",e})(_||{});var de=Object.defineProperty,he=(e,t)=>{for(var r in t)de(e,r,{get:t[r],enumerable:!0})},h={};he(h,{createEndpoint:()=>K,expose:()=>L,proxy:()=>oe,proxyMarker:()=>O,releaseProxy:()=>X,transfer:()=>ne,transferHandlers:()=>I,windowEndpoint:()=>ge,wrap:()=>te});var O=Symbol("Comlink.proxy"),K=Symbol("Comlink.endpoint"),X=Symbol("Comlink.releaseProxy"),A=Symbol("Comlink.thrown"),Z=e=>typeof e=="object"&&e!==null||typeof e=="function",pe={canHandle:e=>Z(e)&&e[O],serialize(e){let{port1:t,port2:r}=new MessageChannel;return L(e,t),[r,[r]]},deserialize(e){return e.start(),te(e)}},we={canHandle:e=>Z(e)&&A in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},I=new Map([["proxy",pe],["throw",we]]);function L(e,t=self){t.addEventListener("message",function r(n){if(!n||!n.data)return;let{id:o,type:s,path:i}=Object.assign({path:[]},n.data),a=(n.data.argumentList||[]).map(g),l;try{let u=i.slice(0,-1).reduce((f,w)=>f[w],e),d=i.reduce((f,w)=>f[w],e);switch(s){case 0:l=d;break;case 1:u[i.slice(-1)[0]]=g(n.data.value),l=!0;break;case 2:l=d.apply(u,a);break;case 3:{let f=new d(...a);l=oe(f)}break;case 4:{let{port1:f,port2:w}=new MessageChannel;L(e,w),l=ne(f,[f])}break;case 5:l=void 0;break}}catch(u){l={value:u,[A]:0}}Promise.resolve(l).catch(u=>({value:u,[A]:0})).then(u=>{let[d,f]=N(u);t.postMessage(Object.assign(Object.assign({},d),{id:o}),f),s===5&&(t.removeEventListener("message",r),ee(t))})}),t.start&&t.start()}function me(e){return e.constructor.name==="MessagePort"}function ee(e){me(e)&&e.close()}function te(e,t){return T(e,[],t)}function R(e){if(e)throw new Error("Proxy has been released and is not useable")}function T(e,t=[],r=function(){}){let n=!1,o=new Proxy(r,{get(s,i){if(R(n),i===X)return()=>b(e,{type:5,path:t.map(a=>a.toString())}).then(()=>{ee(e),n=!0});if(i==="then"){if(t.length===0)return{then:()=>o};let a=b(e,{type:0,path:t.map(l=>l.toString())}).then(g);return a.then.bind(a)}return T(e,[...t,i])},set(s,i,a){R(n);let[l,u]=N(a);return b(e,{type:1,path:[...t,i].map(d=>d.toString()),value:l},u).then(g)},apply(s,i,a){R(n);let l=t[t.length-1];if(l===K)return b(e,{type:4}).then(g);if(l==="bind")return T(e,t.slice(0,-1));let[u,d]=Q(a);return b(e,{type:2,path:t.map(f=>f.toString()),argumentList:u},d).then(g)},construct(s,i){R(n);let[a,l]=Q(i);return b(e,{type:3,path:t.map(u=>u.toString()),argumentList:a},l).then(g)}});return o}function _e(e){return Array.prototype.concat.apply([],e)}function Q(e){let t=e.map(N);return[t.map(r=>r[0]),_e(t.map(r=>r[1]))]}var re=new WeakMap;function ne(e,t){return re.set(e,t),e}function oe(e){return Object.assign(e,{[O]:!0})}function ge(e,t=self,r="*"){return{postMessage:(n,o)=>e.postMessage(n,r,o),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function N(e){for(let[t,r]of I)if(r.canHandle(e)){let[n,o]=r.serialize(e);return[{type:3,name:t,value:n},o]}return[{type:0,value:e},re.get(e)||[]]}function g(e){switch(e.type){case 3:return I.get(e.name).deserialize(e.value);case 0:return e.value}}function b(e,t,r){return new Promise(n=>{let o=ye();e.addEventListener("message",function s(i){!i.data||!i.data.id||i.data.id!==o||(e.removeEventListener("message",s),n(i.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:o},t),r)})}function ye(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var Ee=[_.ConsoleError,_.UncaughtException,_.UnhandledRejection];function M(e){return!(e==null||typeof e!="object"||!("type"in e)||!Ee.includes(e.type))}function y(e){let t=Object.create(null);return e?Object.assign(t,e):t}var be=new TextDecoder("latin1");function U(e){let t={d:{}};for(let r of Object.keys(e)){let n=e[r];if("file"in n){if("symlink"in n.file){t.d[r]={f:{l:n.file.symlink}};continue}let s=n.file.contents,i=typeof s=="string"?s:be.decode(s),a=typeof s=="string"?{}:{b:!0};t.d[r]={f:k({c:i},a)};continue}let o=U(n.directory);t.d[r]=o}return t}function D(e){let t=y();if("f"in e)throw new Error("It is not possible to export a single file in the JSON format.");if("d"in e)for(let r of Object.keys(e.d)){let n=e.d[r];"d"in n?t[r]=y({directory:D(n)}):"f"in n&&("c"in n.f?t[r]=y({file:y({contents:n.f.b?ke(n.f.c):n.f.c})}):"l"in n.f&&(t[r]=y({file:y({symlink:n.f.l})})))}return t}function ke(e){let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e[r].charCodeAt(0);return t}var v=null,P=null,F={},se=new TextDecoder,Se=new TextEncoder,G=(()=>{class e{_instance;_runtimeInfo;fs;static _instance=null;static _teardownPromise=null;_tornDown=!1;_unsubscribeFromTokenChangedListener=()=>{};constructor(r,n,o,s){this._instance=r,this._runtimeInfo=s,this.fs=new V(n),p.initialized&&(this._unsubscribeFromTokenChangedListener=q(i=>{this._instance.setCredentials({accessToken:i,editorOrigin:p.editorOrigin})}),c(this,null,function*(){yield p.authComplete.promise,!this._tornDown&&(Y(p.tokens),yield this._instance.setCredentials({accessToken:p.tokens.access,editorOrigin:p.editorOrigin}))}).catch(i=>{console.error(i)}))}spawn(r,n,o){return c(this,null,function*(){let s=[];Array.isArray(n)?s=n:o=n;let i,a=new ReadableStream;if(o?.output!==!1){let $=Te();i=$.push,a=$.stream}let l,u,d,f,w=C(z(i)),ae=C(z(l)),ce=C(z(d)),le=yield this._instance.run({command:r,args:s,cwd:o?.cwd,env:o?.env,terminal:o?.terminal},ae,ce,w);return new H(le,a,u,f)})}export(r,n){return c(this,null,function*(){let o={format:n?.format??"json",includes:n?.includes,excludes:n?.excludes,external:!0},s=yield this._instance.serialize(r,o);if(o.format==="json"){let i=JSON.parse(se.decode(s));return D(i)}return s})}on(r,n){if(r==="preview-message"){let i=n;n=a=>{M(a)&&i(a)}}let{listener:o,subscribe:s}=Oe(n);return s(this._instance.on(r,h.proxy(o)))}mount(r,n){let o=r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):Se.encode(JSON.stringify(U(r)));return this._instance.loadFiles(h.transfer(o,[o.buffer]),{mountPoints:n?.mountPoint})}setPreviewScript(r,n){return this._instance.setPreviewScript(r,n)}get path(){return this._runtimeInfo.path}get workdir(){return this._runtimeInfo.cwd}teardown(){if(this._tornDown)throw new Error("WebContainer already torn down");this._tornDown=!0,this._unsubscribeFromTokenChangedListener();let r=()=>c(this,null,function*(){try{yield this.fs._teardown(),yield this._instance.teardown()}finally{this._instance[h.releaseProxy](),e._instance===this&&(e._instance=null)}});e._teardownPromise=r()}static boot(){return c(this,arguments,function*(r={}){yield this._teardownPromise,e._teardownPromise=null;let{workdirName:n}=r;if(window.crossOriginIsolated&&r.coep==="none"&&console.warn(`A Cross-Origin-Embedder-Policy header is required in cross origin isolated environments.
Set the 'coep' option to 'require-corp'.`),n?.includes("/")||n===".."||n===".")throw new Error("workdirName should be a valid folder name");for(p.bootCalled=!0;v;)yield v;if(e._instance)throw new Error("Only a single WebContainer instance can be booted");let o=Pe(r);v=o.catch(()=>{});try{let s=yield o;return e._instance=s,s}finally{v=null}})}}return e})();var Re=1,ve=2,W=class{name;_type;constructor(t,r){this.name=t,this._type=r}isFile(){return this._type===Re}isDirectory(){return this._type===ve}},j=class{_apiClient;_path;_options;_listener;_wrappedListener;_watcher;_closed=!1;constructor(t,r,n,o){this._apiClient=t,this._path=r,this._options=n,this._listener=o,this._apiClient._watchers.add(this),this._wrappedListener=(s,i)=>{this._listener&&!this._closed&&this._listener(s,i)},this._apiClient._fs.watch(this._path,this._options,C(this._wrappedListener)).then(s=>{if(this._watcher=s,this._closed)return this._teardown()}).catch(console.error)}close(){return c(this,null,function*(){this._closed||(this._closed=!0,this._apiClient._watchers.delete(this),yield this._teardown())})}_teardown(){return c(this,null,function*(){yield this._watcher?.close().finally(()=>{this._watcher?.[h.releaseProxy]()})})}},H=class{output;input;exit;_process;stdout;stderr;constructor(t,r,n,o){this.output=r,this._process=t,this.input=new WritableStream({write:s=>{this._getProcess()?.write(s).catch(()=>{})}}),this.exit=this._onExit(),this.stdout=n,this.stderr=o}kill(){this._process?.kill()}resize(t){this._getProcess()?.resize(t)}_onExit(){return c(this,null,function*(){try{return yield this._process.onExit}finally{this._process?.[h.releaseProxy](),this._process=null}})}_getProcess(){return this._process==null&&console.warn("This process already exited"),this._process}},V=class{_fs;_watchers=new Set([]);constructor(t){this._fs=t}rm(...t){return this._fs.rm(...t)}readFile(t,r){return c(this,null,function*(){return yield this._fs.readFile(t,r)})}rename(t,r){return c(this,null,function*(){return yield this._fs.rename(t,r)})}writeFile(t,r,n){return c(this,null,function*(){if(r instanceof Uint8Array){let o=r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);r=h.transfer(new Uint8Array(o),[o])}yield this._fs.writeFile(t,r,n)})}readdir(t,r){return c(this,null,function*(){let n=yield this._fs.readdir(t,r);return xe(n)||Ae(n)?n:n.map(s=>new W(s.name,s["Symbol(type)"]))})}mkdir(t,r){return c(this,null,function*(){return yield this._fs.mkdir(t,r)})}watch(t,r,n){return typeof r=="function"&&(n=r,r=null),new j(this,t,r,n)}_teardown(){return c(this,null,function*(){this._fs[h.releaseProxy](),yield Promise.all([...this._watchers].map(t=>t.close()))})}};function Pe(e){return c(this,null,function*(){let{serverPromise:t}=Ce(e),n=yield(yield t).build({host:window.location.host,version:"1.6.1",workdirName:e.workdirName,forwardPreviewErrors:e.forwardPreviewErrors}),[o,s,i]=yield Promise.all([n.fs(),n.previewScript(),n.runtimeInfo()]);return new G(n,o,s,i)})}function z(e){if(e!=null)return t=>{t instanceof Uint8Array?e(se.decode(t)):t==null&&e(null)}}function C(e){if(e!=null)return h.proxy(e)}function Ce(e){if(P!=null)return e.coep!==F.coep&&(console.warn(`Attempting to boot WebContainer with 'coep: ${e.coep}'`),console.warn(`First boot had 'coep: ${F.coep}', new settings will not take effect!`)),{serverPromise:P};e.coep&&E.setQueryParam("coep",e.coep),e.experimentalNode&&E.setQueryParam("experimental_node","1");let t=document.createElement("iframe");t.style.display="none",t.setAttribute("allow","cross-origin-isolated");let r=E.url;t.src=r.toString();let{origin:n}=r;return F=k({},e),P=new Promise(o=>{let s=i=>{if(i.origin!==n)return;let{data:a}=i;if(a.type==="init"){o(h.wrap(i.ports[0]));return}if(a.type==="warning"){console[a.level].call(console,a.message);return}};window.addEventListener("message",s)}),document.body.insertBefore(t,null),{serverPromise:P}}function xe(e){return typeof e[0]=="string"}function Ae(e){return e[0]instanceof Uint8Array}function Te(){let e=null;return{stream:new ReadableStream({start(n){e=n}}),push:n=>{n!=null?e?.enqueue(n):(e?.close(),e=null)}}}function Oe(e){let t=!1,r=()=>{};return{subscribe(o){return o.then(s=>{r=s,t&&r()}),()=>{t=!0,r()}},listener:(...o)=>{t||e(...o)}}}var ie=class{webcontainer=null;isInitialized=!1;initialize(){return c(this,null,function*(){return this.webcontainer&&this.isInitialized?this.webcontainer:(this.validateEnvironment(),console.log("Cross-origin isolation enabled, initializing WebContainer..."),this.webcontainer=yield G.boot(),this.isInitialized=!0,console.log("WebContainer initialized successfully"),this.webcontainer)})}reset(){return c(this,null,function*(){console.log("Resetting WebContainer..."),this.webcontainer&&(this.webcontainer=null,this.isInitialized=!1),console.log("WebContainer reset completed. You may need to refresh the page.")})}isReady(){return this.isInitialized&&this.webcontainer!==null}getWebContainer(){return this.webcontainer}validateEnvironment(){if(!window.crossOriginIsolated)throw new Error("WebContainer requires cross-origin isolation. Please restart the development server and try again.")}};export{ie as WebContainerManagerAppService};
